<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fixit | Service Owner Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Google Fonts for better typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <!-- Compact Mobile Header -->
    <div class="mobile-header">
      <div class="mobile-header-inner">
        <button id="mobileMenuBtn" class="icon-btn" aria-label="Open menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>
        <div class="header-logo">FixIt</div>
        <button id="mobileProfileBtn" class="icon-btn" aria-label="Profile">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </button>
      </div>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="dashboard-body">
      <aside class="dashboard-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-avatar" id="sidebarAvatarOwnerContainer">
            <img id="sidebarAvatarOwner" src="https://via.placeholder.com/64x64/667eea/ffffff?text=O" />
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="sidebar-top">
            <!-- Top section empty for now -->
          </div>
          <div class="sidebar-bottom">
            <a href="#" id="sidebarEditProfile" class="sidebar-link icon-only" title="Edit Profile" aria-label="Edit Profile">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </a>
            <a href="#" id="logoutBtnSidebar" class="sidebar-link icon-only danger" title="Logout" aria-label="Logout" role="button" tabindex="0">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
            </a>
          </div>
        </nav>
      </aside>

      <main class="dashboard-main">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="ongoing-tasks">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4v-7z"></path>
            <path d="M9 11V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
            <path d="M9 11h6v7H9v-7z"></path>
            <path d="M19 11h-4v7h4v-7z"></path>
            <path d="M19 11V9a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"></path>
          </svg>
          Ongoing Tasks
          <span class="notification-badge" id="taskCount">2</span>
        </button>
        <button class="tab-btn" data-tab="history">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
            <path d="M12 7v5l4 2"></path>
          </svg>
          History
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Ongoing Tasks Tab -->
        <div class="tab-panel active" id="ongoing-tasks">
          <div class="panel-header">
            <h3>Active Jobs</h3>
            <p>Monitor your current service requests and their progress</p>
          </div>
          <div class="tasks-grid" id="tasksGrid">
            <!-- Sample task cards will be populated by JavaScript -->
          </div>
        </div>

        <!-- History Tab -->
        <div class="tab-panel" id="history">
          <div class="panel-header">
            <h3>Service History</h3>
            <p>View all your previous service providers and rehire them</p>
          </div>
          <div class="history-grid" id="historyGrid">
            <!-- Sample history cards will be populated by JavaScript -->
          </div>
        </div>
      </div>
      </main>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script src="firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Dashboard State Management
    class OwnerDashboard {
      constructor() {
        this.currentTab = 'ongoing-tasks';
        this.ongoingTasks = [];
        this.history = [];
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkAuthState();
        this.loadDashboardData();
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const tab = e.currentTarget.dataset.tab;
            this.switchTab(tab);
          });
        });

        // Mobile header: toggle sidebar
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener('click', () => {
            document.body.classList.add('sidebar-open');
          });
        }
        if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', () => {
            document.body.classList.remove('sidebar-open');
          });
        }

        // Logout - only sidebar logout exists now
        const logoutSidebar = document.getElementById('logoutBtnSidebar');
        if (logoutSidebar) {
          logoutSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Sidebar logout clicked');
            this.logout();
          });
          logoutSidebar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              e.stopPropagation();
              console.log('Sidebar logout keydown');
              this.logout();
            }
          });
        } else {
          console.error('logoutBtnSidebar element not found');
        }

        // Update sidebar avatar in real-time
        auth.onAuthStateChanged(async (user) => {
          if (!user) return;
          db.collection('users').doc(user.uid).onSnapshot((doc) => {
            const data = doc.exists ? doc.data() : {};
            const img = document.getElementById('sidebarAvatarOwner');
            if (img && data.profileImage) img.src = data.profileImage;
          });
        });

        // Sidebar: Edit Profile (icon)
        const editSidebar = document.getElementById('sidebarEditProfile');
        if (editSidebar) {
          editSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Edit profile icon clicked');
            this.editProfile();
          });
        } else {
          console.error('sidebarEditProfile element not found');
        }

        // Stop propagation on avatar container; clicking avatar opens edit profile
        const avatarContainer = document.getElementById('sidebarAvatarOwnerContainer');
        if (avatarContainer) {
          avatarContainer.addEventListener('click', (e) => {
            e.stopPropagation();
            console.log('Avatar container clicked');
            this.editProfile();
          });
        } else {
          console.error('sidebarAvatarOwnerContainer element not found');
        }

        // Settings removed from sidebar

        // Mobile header profile button opens profile modal
        const mobileProfileBtn = document.getElementById('mobileProfileBtn');
        if (mobileProfileBtn) {
          mobileProfileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.editProfile();
          });
        }
      }

      async checkAuthState() {
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "login.html";
            return;
          }
          
          const docRef = await db.collection('users').doc(user.uid).get();
          if (!docRef.exists || docRef.data().role !== 'seeker') {
            alert('Access denied!');
            auth.signOut();
            window.location.href = "login.html";
            return;
          }
          
          this.loadUserProfile(user);
        });
      }

      async loadUserProfile(user) {
        try {
          const profile = await db.collection('users').doc(user.uid).get();
          if (profile.exists) {
            const data = profile.data();
            document.getElementById('ownerName').textContent = data.fullName || 'Service Owner';
            if (data.profileImage) {
              document.getElementById('profileImage').src = data.profileImage;
            }
          }
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      }

      async loadDashboardData() {
        await this.loadOngoingTasks();
        await this.loadHistory();
      }

      async loadOngoingTasks() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const tasksSnapshot = await db.collection('jobs')
            .where('ownerId', '==', user.uid)
            .where('status', 'in', ['accepted', 'in-progress'])
            .orderBy('createdAt', 'desc')
            .get();

          this.ongoingTasks = [];
          for (const doc of tasksSnapshot.docs) {
            const taskData = { id: doc.id, ...doc.data() };
            
            // Get provider details
            if (taskData.providerId) {
              const providerDoc = await db.collection('providers').doc(taskData.providerId).get();
              if (providerDoc.exists) {
                taskData.provider = providerDoc.data();
              }
            }
            
            this.ongoingTasks.push(taskData);
          }

          this.renderOngoingTasks();
          this.updateTaskCount();
        } catch (error) {
          console.error('Error loading ongoing tasks:', error);
        }
      }

      async loadHistory() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const historySnapshot = await db.collection('jobs')
            .where('ownerId', '==', user.uid)
            .where('status', '==', 'completed')
            .orderBy('completedAt', 'desc')
            .get();

          this.history = [];
          for (const doc of historySnapshot.docs) {
            const historyData = { id: doc.id, ...doc.data() };
            
            // Get provider details
            if (historyData.providerId) {
              const providerDoc = await db.collection('providers').doc(historyData.providerId).get();
              if (providerDoc.exists) {
                historyData.provider = providerDoc.data();
              }
            }
            
            this.history.push(historyData);
          }

          this.renderHistory();
        } catch (error) {
          console.error('Error loading history:', error);
        }
      }

      renderOngoingTasks() {
        const grid = document.getElementById('tasksGrid');
        
        if (this.ongoingTasks.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4v-7z"></path>
                <path d="M9 11V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                <path d="M9 11h6v7H9v-7z"></path>
                <path d="M19 11h-4v7h4v-7z"></path>
                <path d="M19 11V9a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2"></path>
              </svg>
              <h3>No active tasks</h3>
              <p>Your ongoing service requests will appear here</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.ongoingTasks.map(task => `
          <div class="task-card">
            <div class="card-header">
              <div class="provider-info">
                <div class="provider-avatar">
                  <img src="https://via.placeholder.com/40x40/48bb78/ffffff?text=P" alt="Provider" />
                </div>
                <div class="provider-details">
                  <h4>${task.provider?.name || 'Provider'}</h4>
                  <p class="service-type">${task.provider?.service || 'Service'}</p>
                </div>
              </div>
              <div class="task-status ${task.status}">${this.formatStatus(task.status)}</div>
            </div>
            <div class="card-content">
              <div class="task-details">
                <div class="detail-item">
                  <span class="label">Service:</span>
                  <span class="value">${task.serviceType || 'General Service'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Description:</span>
                  <span class="value">${task.description || 'No description provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Budget:</span>
                  <span class="value">$${task.budget || 'Not specified'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Started:</span>
                  <span class="value">${this.formatDate(task.acceptedAt || task.createdAt)}</span>
                </div>
              </div>
              <div class="progress-section">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${this.getProgress(task.status)}%"></div>
                </div>
                <span class="progress-text">${this.getProgress(task.status)}% Complete</span>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-secondary" onclick="dashboard.viewDetails('${task.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                View Details
              </button>
              <button class="btn btn-primary" onclick="dashboard.contactProvider('${task.providerId}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                Contact
              </button>
            </div>
          </div>
        `).join('');
      }

      renderHistory() {
        const grid = document.getElementById('historyGrid');
        
        if (this.history.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
                <path d="M12 7v5l4 2"></path>
              </svg>
              <h3>No service history</h3>
              <p>Your completed services will appear here</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.history.map(job => `
          <div class="history-card">
            <div class="card-header">
              <div class="provider-info">
                <div class="provider-avatar">
                  <img src="https://via.placeholder.com/40x40/48bb78/ffffff?text=P" alt="Provider" />
                </div>
                <div class="provider-details">
                  <h4>${job.provider?.name || 'Provider'}</h4>
                  <p class="service-type">${job.provider?.service || 'Service'}</p>
                </div>
              </div>
              <div class="job-rating">
                ${this.renderStars(job.rating || 0)}
                <span class="rating-text">${job.rating || 0}/5</span>
              </div>
            </div>
            <div class="card-content">
              <div class="job-details">
                <div class="detail-item">
                  <span class="label">Service:</span>
                  <span class="value">${job.serviceType || 'Service Completed'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Completed:</span>
                  <span class="value">${this.formatDate(job.completedAt)}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Payment:</span>
                  <span class="value">$${job.payment || '0'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Experience:</span>
                  <span class="value">${job.provider?.experience || '5'}+ Years</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-secondary" onclick="dashboard.viewProviderProfile('${job.providerId}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                View Profile
              </button>
              <button class="btn btn-primary" onclick="dashboard.rehireProvider('${job.providerId}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <path d="M20 8v6"></path>
                  <path d="M23 11h-6"></path>
                </svg>
                Rehire
              </button>
            </div>
          </div>
        `).join('');
      }

      renderStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 !== 0;
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
          stars += '<span class="star filled">★</span>';
        }
        
        if (hasHalfStar) {
          stars += '<span class="star half">★</span>';
        }
        
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
          stars += '<span class="star">★</span>';
        }
        
        return stars;
      }

      switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        this.currentTab = tabName;
      }

      updateTaskCount() {
        const count = this.ongoingTasks.length;
        const badge = document.getElementById('taskCount');
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }

      formatStatus(status) {
        const statusMap = {
          'accepted': 'Accepted',
          'in-progress': 'In Progress',
          'completed': 'Completed',
          'cancelled': 'Cancelled'
        };
        return statusMap[status] || status;
      }

      getProgress(status) {
        const progressMap = {
          'accepted': 25,
          'in-progress': 75,
          'completed': 100,
          'cancelled': 0
        };
        return progressMap[status] || 0;
      }

      viewDetails(taskId) {
        this.showNotification('View details feature coming soon!', 'info');
      }

      contactProvider(providerId) {
        this.showNotification('Contact provider feature coming soon!', 'info');
      }

      viewProviderProfile(providerId) {
        this.showNotification('View provider profile feature coming soon!', 'info');
      }

      rehireProvider(providerId) {
        this.showNotification('Rehire provider feature coming soon!', 'info');
      }

      editProfile() {
        console.log('editProfile method called');
        const modal = document.getElementById('editProfileModal');
        const overlay = document.getElementById('modalOverlay');
        
        if (!modal) {
          console.error('editProfileModal not found');
          return;
        }
        if (!overlay) {
          console.error('modalOverlay not found');
          return;
        }
        
        console.log('Opening edit profile modal');
        modal.style.display = 'block';
        overlay.classList.add('show');
        modal.classList.add('show');
      }

      logout() {
        auth.signOut().then(() => {
          this.showNotification('Logged out successfully', 'success');
          setTimeout(() => {
            window.location.href = "login.html";
          }, 400);
        }).catch((err) => {
          this.showNotification(err?.message || 'Logout failed', 'error');
        });
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      formatDate(date) {
        if (!date) return 'Unknown date';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
    }

    // Initialize dashboard
    const dashboard = new OwnerDashboard();

    // Edit Profile Modal (injected) with image upload + pricing
    (function ensureEditProfileModal() {
      if (document.getElementById('editProfileModal')) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class=\"modal-overlay\" id=\"modalOverlay\"></div>
        <div class=\"modal\" id=\"editProfileModal\" role=\"dialog\" aria-modal=\"true\" aria-labelledby=\"editProfileTitle\">
          <div class=\"modal-header\">
            <h3 id=\"editProfileTitle\">Edit Profile</h3>
            <button class=\"modal-close\" id=\"closeProfileModal\" aria-label=\"Close\">×</button>
          </div>
          <div class=\"modal-body\">
            <div class=\"edit-profile-grid\">
              <div class=\"avatar-uploader\">
                <div class=\"avatar-preview\">
                  <img id=\"editAvatarPreview\" src=\"https://via.placeholder.com/120x120/667eea/ffffff?text=O\" />
                </div>
                <input type=\"file\" id=\"avatarInput\" accept=\"image/png, image/jpeg\" style=\"display: none;\" />
                <button type=\"button\" id=\"cameraBtn\" class=\"camera-btn\" aria-label=\"Upload photo\">
                  <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">
                    <path d=\"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z\"></path>
                    <circle cx=\"12\" cy=\"13\" r=\"4\"></circle>
                  </svg>
                  <span>Upload Photo</span>
                </button>
                <small class=\"hint\">PNG/JPG up to ~2MB</small>
              </div>
              <div class=\"profile-fields\">
                <label class="field">
                  <span>Full Name</span>
                  <input type="text" id="editName" placeholder="Your name" />
                </label>
                <label class="field">
                  <span>Address</span>
                  <input type="text" id="editAddress" placeholder="Your address" />
                </label>
              </div>
            </div>
          </div>
          <div class=\"modal-footer\">
            <button class=\"btn btn-secondary\" id=\"cancelProfileModal\">Cancel</button>
            <button class=\"btn btn-primary\" id=\"saveProfileBtn\">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrapper);

      const overlay = document.getElementById('modalOverlay');
      const modal = document.getElementById('editProfileModal');
      const closeBtn = document.getElementById('closeProfileModal');
      const cancelBtn = document.getElementById('cancelProfileModal');
      const avatarInput = document.getElementById('avatarInput');
      const cameraBtn = document.getElementById('cameraBtn');
      const previewImg = document.getElementById('editAvatarPreview');
      const saveBtn = document.getElementById('saveProfileBtn');

      // Camera button triggers file input
      cameraBtn.addEventListener('click', () => {
        avatarInput.click();
      });

      function closeModal() {
        console.log('Closing modal');
        overlay.classList.remove('show');
        modal.classList.remove('show');
        
        // Wait for CSS transition to complete before hiding
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      overlay.addEventListener('click', closeModal);
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);

      // Prefill
      auth.onAuthStateChanged(async (user) => {
        if (!user) return;
        const userDoc = await db.collection('users').doc(user.uid).get();
        const data = userDoc.exists ? userDoc.data() : {};
        document.getElementById('editName').value = data.fullName || '';
        document.getElementById('editAddress').value = data.address || '';
        if (data.profileImage) previewImg.src = data.profileImage;
      });

      // Preview selection and update immediately
      avatarInput.addEventListener('change', () => {
        const file = avatarInput.files && avatarInput.files[0];
        if (!file) return;
        
        // Validate file type immediately
        if (!file.type.match(/image\/(png|jpeg|jpg)/)) {
          dashboard.showNotification('Only PNG and JPG images are allowed', 'error');
          avatarInput.value = '';
          return;
        }
        
        // Validate file size immediately
        if (file.size > 2 * 1024 * 1024) {
          dashboard.showNotification('Image size must be less than 2MB', 'error');
          avatarInput.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          // Update preview in modal
          previewImg.src = e.target.result;
          
          // Update header image preview
          const headerImg = document.getElementById('profileImage');
          if (headerImg) headerImg.src = e.target.result;
          
          // Update sidebar avatar preview
          const sidebarImg = document.getElementById('sidebarAvatarOwner');
          if (sidebarImg) sidebarImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Save to Firestore (users) and Storage
      saveBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) {
          dashboard.showNotification('You must be logged in to update your profile', 'error');
          return;
        }

        const fullName = (document.getElementById('editName').value || '').trim();
        const address = (document.getElementById('editAddress').value || '').trim();

        // Validation
        if (!fullName) {
          dashboard.showNotification('Full name is required', 'error');
          return;
        }

        if (fullName.length < 2) {
          dashboard.showNotification('Full name must be at least 2 characters', 'error');
          return;
        }

        // Set loading state
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        saveBtn.style.opacity = '0.7';
        saveBtn.style.cursor = 'not-allowed';

        const updateData = {
          fullName,
          address,
          updatedAt: new Date()
        };

        try {
          const file = avatarInput.files && avatarInput.files[0];
          if (file) {
            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
              throw new Error('Image size must be less than 2MB');
            }

            // Validate file type
            if (!file.type.match(/image\/(png|jpeg|jpg)/)) {
              throw new Error('Only PNG and JPG images are allowed');
            }

            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`profileImages/${user.uid}`);
            await fileRef.put(file);
            const url = await fileRef.getDownloadURL();
            updateData.profileImage = url;
            
            // Update header image
            const headerImg = document.getElementById('profileImage');
            if (headerImg) headerImg.src = url;
            
            // Update sidebar avatar
            const sidebarImg = document.getElementById('sidebarAvatarOwner');
            if (sidebarImg) sidebarImg.src = url;
          }

          await db.collection('users').doc(user.uid).set(updateData, { merge: true });
          
          // Update UI elements
          if (fullName) {
            const ownerNameEl = document.getElementById('ownerName');
            if (ownerNameEl) ownerNameEl.textContent = fullName;
          }
          
          dashboard.showNotification('Profile updated successfully!', 'success');
          closeModal();
        } catch (err) {
          console.error('Error updating profile:', err);
          const errorMessage = err.message || 'Failed to update profile. Please try again.';
          dashboard.showNotification(errorMessage, 'error');
        } finally {
          // Reset loading state
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Changes';
          saveBtn.style.opacity = '1';
          saveBtn.style.cursor = 'pointer';
        }
      });
    })();
  </script>
</body>
</html>