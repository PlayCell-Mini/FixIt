<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fixit | Service Owner Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>üîç Service Owner Dashboard</h2>

  <div>
    <p>Welcome, <span id="owner-email"></span></p>
    <select id="serviceFilter">
      <option value="">Select Service</option>
      <option value="Plumber">Plumber</option>
      <option value="Electrician">Electrician</option>
      <option value="Tutor">Tutor</option>
    </select>
    <button id="searchBtn">Search</button>

    <div id="providerList"></div>

    <button id="logout">Logout</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script src="firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Check auth state
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const docRef = await db.collection('users').doc(user.uid).get();
      if (!docRef.exists || docRef.data().role !== 'seeker') {
        alert('Access denied!');
        auth.signOut();
        window.location.href = "login.html";
        return;
      }
      document.getElementById('owner-email').innerText = user.email;
    });

    // Search providers
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const service = document.getElementById('serviceFilter').value;
      const listDiv = document.getElementById('providerList');
      listDiv.innerHTML = '';

      if (!service) return alert('Select a service');

      const querySnapshot = await db.collection('providers')
        .where('service', '==', service)
        .where('available', '==', true)
        .get();

      if (querySnapshot.empty) {
        listDiv.innerHTML = '<p>No providers available</p>';
      } else {
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement('div');
          div.innerHTML = `
            <p><strong>${data.name}</strong> (${data.service})<br>
            Hourly: ${data.hourlyRate}, Daily: ${data.dailyRate}<br>
            <button onclick="hire('${doc.id}')">Hire</button></p>
          `;
          listDiv.appendChild(div);
        });
      }
    });

    async function hire(providerId) {
      const user = auth.currentUser;
      await db.collection('jobs').add({
        providerId: providerId,
        ownerId: user.uid,
        status: 'pending',
        createdAt: new Date()
      });
      alert('Hire request sent!');
    }

    document.getElementById('logout').addEventListener('click', () => {
      auth.signOut();
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
