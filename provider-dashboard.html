<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fixit | Provider Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Google Fonts for better typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <!-- Header Section -->
    <header class="dashboard-header">
      <div class="header-content">
        <div class="profile-section">
          <div class="profile-picture">
            <img id="profileImage" src="https://via.placeholder.com/50x50/667eea/ffffff?text=P" alt="Profile" />
            <div class="online-indicator" id="onlineIndicator"></div>
          </div>
          <div class="profile-info">
            <h2 id="providerName">John Doe</h2>
            <div class="experience-badge">
              <span id="experienceLevel">5+ Years</span>
            </div>
          </div>
        </div>
        
        <div class="header-actions">
          <div class="profile-dropdown">
            <button class="profile-settings-btn" id="profileSettingsBtn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
            </button>
            <div class="dropdown-menu" id="profileDropdown">
              <a href="#" class="dropdown-item" id="editProfileBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit Profile
              </a>
              <a href="#" class="dropdown-item" id="setPricingBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                Set Pricing
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item logout-item" id="logoutBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16,17 21,12 16,7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Dashboard Content -->
    <main class="dashboard-main">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="hire-requests">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <path d="M20 8v6"></path>
            <path d="M23 11h-6"></path>
          </svg>
          Hire Requests
          <span class="notification-badge" id="requestCount">3</span>
        </button>
        <button class="tab-btn" data-tab="completed-jobs">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4"></path>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
            <path d="M13 12h3a2 2 0 0 1 2 2v1"></path>
            <path d="M13 12H9a2 2 0 0 0-2 2v1"></path>
          </svg>
          Completed Jobs
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Hire Requests Tab -->
        <div class="tab-panel active" id="hire-requests">
          <div class="panel-header">
            <h3>New Hire Requests</h3>
            <p>Review and respond to service requests from owners</p>
          </div>
          <div class="requests-grid" id="requestsGrid">
            <!-- Sample request cards will be populated by JavaScript -->
          </div>
        </div>

        <!-- Completed Jobs Tab -->
        <div class="tab-panel" id="completed-jobs">
          <div class="panel-header">
            <h3>Job History</h3>
            <p>View your completed jobs and ratings</p>
          </div>
          <div class="jobs-grid" id="jobsGrid">
            <!-- Sample job cards will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script src="firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Dashboard State Management
    class ProviderDashboard {
      constructor() {
        this.currentTab = 'hire-requests';
        this.isOnline = true;
        this.requests = [];
        this.completedJobs = [];
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkAuthState();
        this.loadDashboardData();
        this.startOnlineStatus();
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const tab = e.currentTarget.dataset.tab;
            this.switchTab(tab);
          });
        });

        // Profile dropdown
        const profileBtn = document.getElementById('profileSettingsBtn');
        const dropdown = document.getElementById('profileDropdown');
        
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          dropdown.classList.remove('show');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
          this.logout();
        });

        // Edit Profile
        document.getElementById('editProfileBtn').addEventListener('click', (e) => {
          e.preventDefault();
          this.editProfile();
        });

        // Set Pricing
        document.getElementById('setPricingBtn').addEventListener('click', (e) => {
          e.preventDefault();
          this.setPricing();
        });
      }

      async checkAuthState() {
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "login.html";
            return;
          }
          
          const docRef = await db.collection('users').doc(user.uid).get();
          if (!docRef.exists || docRef.data().role !== 'provider') {
            alert('Access denied!');
            auth.signOut();
            window.location.href = "login.html";
            return;
          }
          
          this.loadUserProfile(user);
        });
      }

      async loadUserProfile(user) {
        try {
          const profile = await db.collection('providers').doc(user.uid).get();
          if (profile.exists) {
            const data = profile.data();
            document.getElementById('providerName').textContent = data.name || 'Provider';
            document.getElementById('experienceLevel').textContent = `${data.experience || '5'}+ Years`;
            if (data.profileImage) {
              document.getElementById('profileImage').src = data.profileImage;
            }
          }
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      }

      async loadDashboardData() {
        await this.loadHireRequests();
        await this.loadCompletedJobs();
      }

      async loadHireRequests() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const requestsSnapshot = await db.collection('jobs')
            .where('providerId', '==', user.uid)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .get();

          this.requests = [];
          requestsSnapshot.forEach(doc => {
            this.requests.push({ id: doc.id, ...doc.data() });
          });

          this.renderHireRequests();
          this.updateRequestCount();
        } catch (error) {
          console.error('Error loading hire requests:', error);
        }
      }

      async loadCompletedJobs() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const jobsSnapshot = await db.collection('jobs')
            .where('providerId', '==', user.uid)
            .where('status', '==', 'completed')
            .orderBy('completedAt', 'desc')
            .get();

          this.completedJobs = [];
          jobsSnapshot.forEach(doc => {
            this.completedJobs.push({ id: doc.id, ...doc.data() });
          });

          this.renderCompletedJobs();
        } catch (error) {
          console.error('Error loading completed jobs:', error);
        }
      }

      renderHireRequests() {
        const grid = document.getElementById('requestsGrid');
        
        if (this.requests.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <path d="M20 8v6"></path>
                <path d="M23 11h-6"></path>
              </svg>
              <h3>No new requests</h3>
              <p>You'll see new hire requests here when owners contact you</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.requests.map(request => `
          <div class="request-card">
            <div class="card-header">
              <div class="owner-info">
                <div class="owner-avatar">
                  <img src="https://via.placeholder.com/40x40/667eea/ffffff?text=O" alt="Owner" />
                </div>
                <div class="owner-details">
                  <h4>Service Request</h4>
                  <p class="request-date">${this.formatDate(request.createdAt)}</p>
                </div>
              </div>
              <div class="request-status pending">Pending</div>
            </div>
            <div class="card-content">
              <div class="service-details">
                <div class="detail-item">
                  <span class="label">Service Type:</span>
                  <span class="value">${request.serviceType || 'General Service'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Description:</span>
                  <span class="value">${request.description || 'No description provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Budget:</span>
                  <span class="value">$${request.budget || 'Not specified'}</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-reject" onclick="dashboard.rejectRequest('${request.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Reject
              </button>
              <button class="btn btn-accept" onclick="dashboard.acceptRequest('${request.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"></path>
                </svg>
                Accept
              </button>
            </div>
          </div>
        `).join('');
      }

      renderCompletedJobs() {
        const grid = document.getElementById('jobsGrid');
        
        if (this.completedJobs.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M9 12l2 2 4-4"></path>
                <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
                <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
                <path d="M13 12h3a2 2 0 0 1 2 2v1"></path>
                <path d="M13 12H9a2 2 0 0 0-2 2v1"></path>
              </svg>
              <h3>No completed jobs</h3>
              <p>Your completed jobs will appear here</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.completedJobs.map(job => `
          <div class="job-card">
            <div class="card-header">
              <div class="job-info">
                <h4>${job.serviceType || 'Service Completed'}</h4>
                <p class="job-date">Completed ${this.formatDate(job.completedAt)}</p>
              </div>
              <div class="job-status completed">Completed</div>
            </div>
            <div class="card-content">
              <div class="job-details">
                <div class="detail-item">
                  <span class="label">Payment:</span>
                  <span class="value">$${job.payment || '0'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Rating:</span>
                  <div class="rating">
                    ${this.renderStars(job.rating || 0)}
                    <span class="rating-text">${job.rating || 0}/5</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      renderStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 !== 0;
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
          stars += '<span class="star filled">★</span>';
        }
        
        if (hasHalfStar) {
          stars += '<span class="star half">★</span>';
        }
        
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
          stars += '<span class="star">★</span>';
        }
        
        return stars;
      }

      switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        this.currentTab = tabName;
      }

      updateRequestCount() {
        const count = this.requests.length;
        const badge = document.getElementById('requestCount');
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }

      startOnlineStatus() {
        // Simulate online status
        this.isOnline = true;
        this.updateOnlineStatus();
        
        // Update online status every 30 seconds
        setInterval(() => {
          this.updateOnlineStatus();
        }, 30000);
      }

      updateOnlineStatus() {
        const indicator = document.getElementById('onlineIndicator');
        if (this.isOnline) {
          indicator.classList.add('online');
          indicator.classList.remove('offline');
        } else {
          indicator.classList.add('offline');
          indicator.classList.remove('online');
        }
      }

      async acceptRequest(requestId) {
        try {
          await db.collection('jobs').doc(requestId).update({
            status: 'accepted',
            acceptedAt: new Date()
          });
          
          this.loadHireRequests();
          this.showNotification('Request accepted successfully!', 'success');
        } catch (error) {
          console.error('Error accepting request:', error);
          this.showNotification('Failed to accept request', 'error');
        }
      }

      async rejectRequest(requestId) {
        try {
          await db.collection('jobs').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date()
          });
          
          this.loadHireRequests();
          this.showNotification('Request rejected', 'info');
        } catch (error) {
          console.error('Error rejecting request:', error);
          this.showNotification('Failed to reject request', 'error');
        }
      }

      editProfile() {
        const modal = document.getElementById('editProfileModal');
        const overlay = document.getElementById('modalOverlay');
        modal.classList.add('show');
        overlay.classList.add('show');
      }

      setPricing() {
        // Implement set pricing functionality
        this.showNotification('Set pricing feature coming soon!', 'info');
      }

      logout() {
        auth.signOut().then(() => {
          window.location.href = "login.html";
        });
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      formatDate(date) {
        if (!date) return 'Unknown date';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
    }

    // Initialize dashboard
    const dashboard = new ProviderDashboard();

    // Edit Profile Modal Markup (injected at runtime to keep HTML minimal)
    (function ensureEditProfileModal() {
      if (document.getElementById('editProfileModal')) return;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal" id="editProfileModal" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
          <div class="modal-header">
            <h3 id="editProfileTitle">Edit Profile</h3>
            <button class="modal-close" id="closeProfileModal" aria-label="Close">×</button>
          </div>
          <div class="modal-body">
            <div class="edit-profile-grid">
              <div class="avatar-uploader">
                <div class="avatar-preview">
                  <img id="editAvatarPreview" src="https://via.placeholder.com/120x120/667eea/ffffff?text=P" alt="Preview" />
                </div>
                <input type="file" id="avatarInput" accept="image/png, image/jpeg" />
                <small class="hint">PNG/JPG up to ~2MB</small>
              </div>
              <div class="profile-fields">
                <label class="field">
                  <span>Name</span>
                  <input type="text" id="editName" placeholder="Your name" />
                </label>
                <label class="field">
                  <span>Experience (years)</span>
                  <select id="editExperience">
                    <option value="1">1</option>
                    <option value="2">2+</option>
                    <option value="5">5+</option>
                    <option value="10">10+</option>
                  </select>
                </label>
                <div class="field-row">
                  <label class="field">
                    <span>Hourly Rate ($)</span>
                    <input type="number" id="editHourly" min="0" step="1" placeholder="e.g. 25" />
                  </label>
                  <label class="field">
                    <span>Daily Rate ($)</span>
                    <input type="number" id="editDaily" min="0" step="1" placeholder="e.g. 150" />
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelProfileModal">Cancel</button>
            <button class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrapper);

      const overlay = document.getElementById('modalOverlay');
      const modal = document.getElementById('editProfileModal');
      const closeBtn = document.getElementById('closeProfileModal');
      const cancelBtn = document.getElementById('cancelProfileModal');
      const avatarInput = document.getElementById('avatarInput');
      const previewImg = document.getElementById('editAvatarPreview');
      const saveBtn = document.getElementById('saveProfileBtn');

      function closeModal() {
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }

      overlay.addEventListener('click', closeModal);
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);

      // Pre-fill fields with current data
      auth.onAuthStateChanged(async (user) => {
        if (!user) return;
        const profileDoc = await db.collection('providers').doc(user.uid).get();
        const data = profileDoc.exists ? profileDoc.data() : {};
        document.getElementById('editName').value = data.name || '';
        document.getElementById('editExperience').value = (data.experience || '5').toString().replace('+','');
        document.getElementById('editHourly').value = data.hourlyRate || '';
        document.getElementById('editDaily').value = data.dailyRate || '';
        if (data.profileImage) previewImg.src = data.profileImage;
      });

      // Preview on select
      avatarInput.addEventListener('change', () => {
        const file = avatarInput.files && avatarInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          const headerImg = document.getElementById('profileImage');
          if (headerImg) headerImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Save profile: upload image if provided, then persist Firestore
      saveBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;

        const name = (document.getElementById('editName').value || '').trim();
        const experience = document.getElementById('editExperience').value;
        const hourlyRate = Number(document.getElementById('editHourly').value || 0);
        const dailyRate = Number(document.getElementById('editDaily').value || 0);

        const updateData = {
          name,
          experience,
          hourlyRate,
          dailyRate,
          updatedAt: new Date()
        };

        try {
          const file = avatarInput.files && avatarInput.files[0];
          if (file) {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`profileImages/${user.uid}`);
            await fileRef.put(file);
            const url = await fileRef.getDownloadURL();
            updateData.profileImage = url;
            // Update header image
            const headerImg = document.getElementById('profileImage');
            if (headerImg) headerImg.src = url;
          }

          await db.collection('providers').doc(user.uid).set(updateData, { merge: true });
          // Reflect name/experience in header
          if (name) document.getElementById('providerName').textContent = name;
          if (experience) document.getElementById('experienceLevel').textContent = `${experience}+ Years`;

          dashboard.showNotification('Profile updated', 'success');
          closeModal();
        } catch (err) {
          console.error(err);
          dashboard.showNotification('Failed to update profile', 'error');
        }
      });
    })();
  </script>
</body>
</html>