<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fixit | Provider Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Google Fonts for better typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <!-- Compact Mobile Header -->
    <div class="mobile-header">
      <div class="mobile-header-inner">
        <button id="mobileMenuBtn" class="icon-btn" aria-label="Open menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>
        <div class="header-logo">FixIt</div>
        <button id="mobileProfileBtn" class="icon-btn" aria-label="Profile">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </button>
      </div>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="dashboard-body">
      <aside class="dashboard-sidebar">
        <div class="sidebar-header">
          <div class="sidebar-avatar" id="sidebarAvatarProviderContainer" role="button" tabindex="0" aria-label="Edit profile">
            <img id="sidebarAvatarProvider" src="https://via.placeholder.com/64x64/667eea/ffffff?text=P" alt="Avatar" />
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="sidebar-top">
            <!-- Top section empty for now -->
          </div>
          <div class="sidebar-bottom">
            <a href="#" id="sidebarEditProfile" class="sidebar-link icon-only" title="Edit Profile" aria-label="Edit Profile">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </a>
            <a href="#" id="logoutBtnSidebar" class="sidebar-link icon-only danger" title="Logout" aria-label="Logout" role="button" tabindex="0">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16,17 21,12 16,7"/>
                <line x1="21" y1="12" x2="9" y2="12"/>
              </svg>
            </a>
          </div>
        </nav>
      </aside>

      <main class="dashboard-main">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-btn active" data-tab="hire-requests">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <path d="M20 8v6"></path>
            <path d="M23 11h-6"></path>
          </svg>
          Hire Requests
          <span class="notification-badge" id="requestCount">3</span>
        </button>
        <button class="tab-btn" data-tab="completed-jobs">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 12l2 2 4-4"></path>
            <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
            <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
            <path d="M13 12h3a2 2 0 0 1 2 2v1"></path>
            <path d="M13 12H9a2 2 0 0 0-2 2v1"></path>
          </svg>
          Completed Jobs
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Hire Requests Tab -->
        <div class="tab-panel active" id="hire-requests">
          <div class="panel-header">
            <h3>New Hire Requests</h3>
            <p>Review and respond to service requests from owners</p>
          </div>
          <div class="requests-grid" id="requestsGrid">
            <!-- Sample request cards will be populated by JavaScript -->
          </div>
        </div>

        <!-- Completed Jobs Tab -->
        <div class="tab-panel" id="completed-jobs">
          <div class="panel-header">
            <h3>Job History</h3>
            <p>View your completed jobs and ratings</p>
          </div>
          <div class="jobs-grid" id="jobsGrid">
            <!-- Sample job cards will be populated by JavaScript -->
          </div>
        </div>
      </div>
      </main>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script src="firebase-config.js"></script>
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Dashboard State Management
    class ProviderDashboard {
      constructor() {
        this.currentTab = 'hire-requests';
        this.isOnline = true;
        this.requests = [];
        this.completedJobs = [];
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.checkAuthState();
        this.loadDashboardData();
        this.startOnlineStatus();
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const tab = e.currentTarget.dataset.tab;
            this.switchTab(tab);
          });
        });

        // Mobile header: toggle sidebar
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener('click', () => {
            document.body.classList.add('sidebar-open');
          });
        }
        if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', () => {
            document.body.classList.remove('sidebar-open');
          });
        }

        // Logout - only sidebar logout exists now
        const logoutSidebar = document.getElementById('logoutBtnSidebar');
        if (logoutSidebar) {
          logoutSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Sidebar logout clicked');
            this.logout();
          });
          logoutSidebar.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              e.stopPropagation();
              console.log('Sidebar logout keydown');
              this.logout();
            }
          });
        } else {
          console.error('logoutBtnSidebar element not found');
        }

        // Update sidebar avatar in real-time
        auth.onAuthStateChanged(async (user) => {
          if (!user) return;
          db.collection('providers').doc(user.uid).onSnapshot((doc) => {
            const data = doc.exists ? doc.data() : {};
            const img = document.getElementById('sidebarAvatarProvider');
            if (img && data.profileImage) img.src = data.profileImage;
          });
        });

        // Sidebar: Edit Profile (icon)
        const editSidebar = document.getElementById('sidebarEditProfile');
        if (editSidebar) {
          editSidebar.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Edit profile icon clicked');
            this.editProfile();
          });
        } else {
          console.error('sidebarEditProfile element not found');
        }

        // Stop propagation on avatar container; clicking avatar opens edit profile
        const avatarContainer = document.getElementById('sidebarAvatarProviderContainer');
        if (avatarContainer) {
          const avatarImg = document.getElementById('sidebarAvatarProvider');
          avatarContainer.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Avatar container clicked');
            this.editProfile();
          });
          avatarContainer.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              e.stopPropagation();
              this.editProfile();
            }
          });
          if (avatarImg) {
            avatarImg.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Avatar image clicked');
              this.editProfile();
            });
          }
        } else {
          console.error('sidebarAvatarProviderContainer element not found');
        }

        // Settings removed from sidebar

        // Mobile header profile button opens profile modal
        const mobileProfileBtn = document.getElementById('mobileProfileBtn');
        if (mobileProfileBtn) {
          mobileProfileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            this.editProfile();
          });
        }
      }

      async checkAuthState() {
        auth.onAuthStateChanged(async (user) => {
          if (!user) {
            window.location.href = "login.html";
            return;
          }
          
          const docRef = await db.collection('users').doc(user.uid).get();
          if (!docRef.exists || docRef.data().role !== 'provider') {
            alert('Access denied!');
            auth.signOut();
            window.location.href = "login.html";
            return;
          }
          
          this.loadUserProfile(user);
        });
      }

      async loadUserProfile(user) {
        try {
          const profile = await db.collection('providers').doc(user.uid).get();
          if (profile.exists) {
            const data = profile.data();
            document.getElementById('providerName').textContent = data.name || 'Provider';
            document.getElementById('experienceLevel').textContent = `${data.experience || '5'}+ Years`;
            if (data.profileImage) {
              document.getElementById('profileImage').src = data.profileImage;
            }
          }
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      }

      async loadDashboardData() {
        await this.loadHireRequests();
        await this.loadCompletedJobs();
      }

      async loadHireRequests() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const requestsSnapshot = await db.collection('jobs')
            .where('providerId', '==', user.uid)
            .where('status', '==', 'pending')
            .orderBy('createdAt', 'desc')
            .get();

          this.requests = [];
          requestsSnapshot.forEach(doc => {
            this.requests.push({ id: doc.id, ...doc.data() });
          });

          this.renderHireRequests();
          this.updateRequestCount();
        } catch (error) {
          console.error('Error loading hire requests:', error);
        }
      }

      async loadCompletedJobs() {
        try {
          const user = auth.currentUser;
          if (!user) return;

          const jobsSnapshot = await db.collection('jobs')
            .where('providerId', '==', user.uid)
            .where('status', '==', 'completed')
            .orderBy('completedAt', 'desc')
            .get();

          this.completedJobs = [];
          jobsSnapshot.forEach(doc => {
            this.completedJobs.push({ id: doc.id, ...doc.data() });
          });

          this.renderCompletedJobs();
        } catch (error) {
          console.error('Error loading completed jobs:', error);
        }
      }

      renderHireRequests() {
        const grid = document.getElementById('requestsGrid');
        
        if (this.requests.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <path d="M20 8v6"></path>
                <path d="M23 11h-6"></path>
              </svg>
              <h3>No new requests</h3>
              <p>You'll see new hire requests here when owners contact you</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.requests.map(request => `
          <div class="request-card">
            <div class="card-header">
              <div class="owner-info">
                <div class="owner-avatar">
                  <img src="https://via.placeholder.com/40x40/667eea/ffffff?text=O" alt="Owner" />
                </div>
                <div class="owner-details">
                  <h4>Service Request</h4>
                  <p class="request-date">${this.formatDate(request.createdAt)}</p>
                </div>
              </div>
              <div class="request-status pending">Pending</div>
            </div>
            <div class="card-content">
              <div class="service-details">
                <div class="detail-item">
                  <span class="label">Service Type:</span>
                  <span class="value">${request.serviceType || 'General Service'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Description:</span>
                  <span class="value">${request.description || 'No description provided'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Budget:</span>
                  <span class="value">$${request.budget || 'Not specified'}</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-reject" onclick="dashboard.rejectRequest('${request.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                Reject
              </button>
              <button class="btn btn-accept" onclick="dashboard.acceptRequest('${request.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6L9 17l-5-5"></path>
                </svg>
                Accept
              </button>
            </div>
          </div>
        `).join('');
      }

      renderCompletedJobs() {
        const grid = document.getElementById('jobsGrid');
        
        if (this.completedJobs.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <path d="M9 12l2 2 4-4"></path>
                <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
                <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
                <path d="M13 12h3a2 2 0 0 1 2 2v1"></path>
                <path d="M13 12H9a2 2 0 0 0-2 2v1"></path>
              </svg>
              <h3>No completed jobs</h3>
              <p>Your completed jobs will appear here</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = this.completedJobs.map(job => `
          <div class="job-card">
            <div class="card-header">
              <div class="job-info">
                <h4>${job.serviceType || 'Service Completed'}</h4>
                <p class="job-date">Completed ${this.formatDate(job.completedAt)}</p>
              </div>
              <div class="job-status completed">Completed</div>
            </div>
            <div class="card-content">
              <div class="job-details">
                <div class="detail-item">
                  <span class="label">Payment:</span>
                  <span class="value">$${job.payment || '0'}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Rating:</span>
                  <div class="rating">
                    ${this.renderStars(job.rating || 0)}
                    <span class="rating-text">${job.rating || 0}/5</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      renderStars(rating) {
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 !== 0;
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
          stars += '<span class="star filled">★</span>';
        }
        
        if (hasHalfStar) {
          stars += '<span class="star half">★</span>';
        }
        
        const emptyStars = 5 - Math.ceil(rating);
        for (let i = 0; i < emptyStars; i++) {
          stars += '<span class="star">★</span>';
        }
        
        return stars;
      }

      switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        this.currentTab = tabName;
      }

      updateRequestCount() {
        const count = this.requests.length;
        const badge = document.getElementById('requestCount');
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }

      startOnlineStatus() {
        // Simulate online status
        this.isOnline = true;
        this.updateOnlineStatus();
        
        // Update online status every 30 seconds
        setInterval(() => {
          this.updateOnlineStatus();
        }, 30000);
      }

      updateOnlineStatus() {
        const indicator = document.getElementById('onlineIndicator');
        if (this.isOnline) {
          indicator.classList.add('online');
          indicator.classList.remove('offline');
        } else {
          indicator.classList.add('offline');
          indicator.classList.remove('online');
        }
      }

      async acceptRequest(requestId) {
        try {
          await db.collection('jobs').doc(requestId).update({
            status: 'accepted',
            acceptedAt: new Date()
          });
          
          this.loadHireRequests();
          this.showNotification('Request accepted successfully!', 'success');
        } catch (error) {
          console.error('Error accepting request:', error);
          this.showNotification('Failed to accept request', 'error');
        }
      }

      async rejectRequest(requestId) {
        try {
          await db.collection('jobs').doc(requestId).update({
            status: 'rejected',
            rejectedAt: new Date()
          });
          
          this.loadHireRequests();
          this.showNotification('Request rejected', 'info');
        } catch (error) {
          console.error('Error rejecting request:', error);
          this.showNotification('Failed to reject request', 'error');
        }
      }

      editProfile() {
        console.log('editProfile method called');
        const modal = document.getElementById('editProfileModal');
        const overlay = document.getElementById('modalOverlay');
        
        if (!modal) {
          console.error('editProfileModal not found');
          return;
        }
        if (!overlay) {
          console.error('modalOverlay not found');
          return;
        }
        
        // Close mobile sidebar if open to avoid z-index/overlay conflicts
        document.body.classList.remove('sidebar-open');

        console.log('Opening edit profile modal');
        console.log('Modal before show:', modal.classList.toString());
        console.log('Overlay before show:', overlay.classList.toString());
        
        modal.classList.add('show');
        overlay.classList.add('show');
        
        console.log('Modal after show:', modal.classList.toString());
        console.log('Overlay after show:', overlay.classList.toString());
        
        // Force a reflow to ensure the changes are applied
        modal.offsetHeight;
        
        // Check if modal is actually visible
        setTimeout(() => {
          const computedStyle = window.getComputedStyle(modal);
          console.log('Modal computed display:', computedStyle.display);
          console.log('Modal computed visibility:', computedStyle.visibility);
          console.log('Modal computed opacity:', computedStyle.opacity);
        }, 100);
      }

      setPricing() {
        // Implement set pricing functionality
        this.showNotification('Set pricing feature coming soon!', 'info');
      }

      logout() {
        auth.signOut().then(() => {
          this.showNotification('Logged out successfully', 'success');
          setTimeout(() => {
            window.location.href = "login.html";
          }, 400);
        }).catch((err) => {
          this.showNotification(err?.message || 'Logout failed', 'error');
        });
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      formatDate(date) {
        if (!date) return 'Unknown date';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
    }

    // Initialize dashboard
    const dashboard = new ProviderDashboard();

    // Edit Profile Modal Markup (injected at runtime to keep HTML minimal)
    // Create modal immediately
    (function ensureEditProfileModal() {
      if (document.getElementById('editProfileModal')) {
        console.log('Edit profile modal already exists');
        return;
      }
      console.log('Creating edit profile modal');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal" id="editProfileModal" role="dialog" aria-modal="true" aria-labelledby="editProfileTitle">
          <div class="modal-header">
            <h3 id="editProfileTitle">Edit Profile</h3>
            <button class="modal-close" id="closeProfileModal" aria-label="Close">×</button>
          </div>
          <div class="modal-body">
            <div class="edit-profile-grid">
              <div class="avatar-uploader">
                <div class="avatar-preview">
                  <img id="editAvatarPreview" src="https://via.placeholder.com/120x120/667eea/ffffff?text=P" alt="Preview" />
                </div>
                <input type="file" id="avatarInput" accept="image/png, image/jpeg" />
                <small class="hint">PNG/JPG up to ~2MB</small>
              </div>
              <div class="profile-fields">
                <label class="field">
                  <span>Name</span>
                  <input type="text" id="editName" placeholder="Your name" />
                </label>
                <label class="field">
                  <span>Service Type</span>
                  <select id="editServiceType">
                    <option value="painter">Painter</option>
                    <option value="plumber">Plumber</option>
                    <option value="welder">Welder</option>
                    <option value="electrician">Electrician</option>
                    <option value="carpenter">Carpenter</option>
                  </select>
                </label>
                <label class="field">
                  <span>Experience (years)</span>
                  <select id="editExperience">
                    <option value="1">1</option>
                    <option value="2">2+</option>
                    <option value="5">5+</option>
                    <option value="10">10+</option>
                  </select>
                </label>
                <div class="field-row">
                  <label class="field">
                    <span>Hourly Rate ($)</span>
                    <input type="number" id="editHourly" min="0" step="1" placeholder="e.g. 25" />
                  </label>
                  <label class="field">
                    <span>Address</span>
                    <input type="text" id="editAddress" placeholder="Your address" />
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelProfileModal">Cancel</button>
            <button class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrapper);
      console.log('Edit profile modal created and appended to body');

      const overlay = document.getElementById('modalOverlay');
      const modal = document.getElementById('editProfileModal');
      const closeBtn = document.getElementById('closeProfileModal');
      const cancelBtn = document.getElementById('cancelProfileModal');
      const avatarInput = document.getElementById('avatarInput');
      const previewImg = document.getElementById('editAvatarPreview');
      const saveBtn = document.getElementById('saveProfileBtn');

      console.log('Modal elements found:', {
        overlay: !!overlay,
        modal: !!modal,
        closeBtn: !!closeBtn,
        cancelBtn: !!cancelBtn,
        avatarInput: !!avatarInput,
        previewImg: !!previewImg,
        saveBtn: !!saveBtn
      });

      function closeModal() {
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      overlay.addEventListener('click', closeModal);
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);

      // Pre-fill fields with current data
      auth.onAuthStateChanged(async (user) => {
        if (!user) return;
        const profileDoc = await db.collection('providers').doc(user.uid).get();
        const data = profileDoc.exists ? profileDoc.data() : {};
        document.getElementById('editName').value = data.name || '';
        document.getElementById('editServiceType').value = (data.serviceType || 'painter');
        document.getElementById('editExperience').value = (data.experience || '5').toString().replace('+','');
        document.getElementById('editHourly').value = data.hourlyRate || '';
        document.getElementById('editAddress').value = data.address || '';
        if (data.profileImage) previewImg.src = data.profileImage;
      });

      // Preview on select
      avatarInput.addEventListener('change', () => {
        const file = avatarInput.files && avatarInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          const headerImg = document.getElementById('profileImage');
          if (headerImg) headerImg.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Save profile: upload image if provided, then persist Firestore
      saveBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;

        const name = (document.getElementById('editName').value || '').trim();
        const serviceType = document.getElementById('editServiceType').value;
        const experience = document.getElementById('editExperience').value;
        const hourlyRate = Number(document.getElementById('editHourly').value || 0);
        const address = (document.getElementById('editAddress').value || '').trim();

        const updateData = {
          name,
          serviceType,
          experience,
          hourlyRate,
          address,
          updatedAt: new Date()
        };

        try {
          const file = avatarInput.files && avatarInput.files[0];
          if (file) {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`profileImages/${user.uid}`);
            await fileRef.put(file);
            const url = await fileRef.getDownloadURL();
            updateData.profileImage = url;
            // Update header image
            const headerImg = document.getElementById('profileImage');
            if (headerImg) headerImg.src = url;
          }

          await db.collection('providers').doc(user.uid).set(updateData, { merge: true });
          // Reflect name/experience in header
          if (name) document.getElementById('providerName').textContent = name;
          if (experience) document.getElementById('experienceLevel').textContent = `${experience}+ Years`;

          dashboard.showNotification('Profile updated', 'success');
          closeModal();
        } catch (err) {
          console.error(err);
          dashboard.showNotification('Failed to update profile', 'error');
        }
      });
    })();
  </script>
</body>
</html>